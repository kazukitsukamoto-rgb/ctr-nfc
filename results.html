<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Choice to Run — Results</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="styles.css" />
  <meta name="theme-color" content="#0d1a2b" />
</head>
<body class="page page--results">
  <header class="appbar">
    <h1>Results</h1>
    <div id="sync-badge" class="badge badge--ok" title="Synced"></div>
  </header>

  <main class="card">
    <div class="results">
      <div class="result-line"><span class="muted">Name</span><strong id="res-name">—</strong></div>
      <div class="result-line"><span class="muted">Course</span><strong id="res-course">—</strong></div>
      <div class="result-line"><span class="muted">Category</span><strong id="res-cat">—</strong></div>
      <div id="res-team-wrap" class="result-line hidden"><span class="muted">Team</span><strong id="res-team">—</strong></div>
      <div class="result-total">
        <div class="lap-label">Laps</div>
        <div id="res-laps" class="lap-count">0</div>
      </div>

      <div class="share-row">
        <button id="send-btn" class="btn btn--primary">Send Result</button>
        <button id="copy-btn" class="btn">Copy</button>
      </div>

      <div class="actions">
        <button id="restart-btn" class="btn btn--danger">Restart</button>
      </div>
    </div>
  </main>

  <div id="toast"></div>

  <script src="app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      window.CTR.updateSyncBadge();
      CTR.trySyncLoop();

      const q = CTR.qs();
      const name = q.name || CTR.get('runner.name') || '';
      const course = q.course || CTR.get('runner.course') || '';
      const category = q.category || CTR.get('runner.category') || '';
      const team = q.team || CTR.get('runner.team') || '';
      const laps = parseInt(q.laps || CTR.get('laps.count') || '0', 10);

      document.getElementById('res-name').textContent = name || '—';
      document.getElementById('res-course').textContent = course === 'serious' ? 'Super Serious Run' : 'Super Fun Run';
      document.getElementById('res-cat').textContent = category === 'team' ? 'Team' : 'Individual';
      if (category === 'team' && team) {
        const wrap = document.getElementById('res-team-wrap');
        document.getElementById('res-team').textContent = team;
        wrap.classList.remove('hidden');
      }
      document.getElementById('res-laps').textContent = laps;

      const shareUrl = new URL(window.location.origin + window.location.pathname);
      shareUrl.searchParams.set('name', name);
      shareUrl.searchParams.set('course', course);
      shareUrl.searchParams.set('category', category);
      shareUrl.searchParams.set('team', team);
      shareUrl.searchParams.set('laps', String(laps));

      const sendBtn = document.getElementById('send-btn');
      if (sendBtn) {
        console.log('Send button found:', sendBtn);
        sendBtn.addEventListener('click', () => {
          console.log('Send Result button clicked');
          try {
            if (typeof CTR.sendFinalManually === 'function') {
              console.log('Calling CTR.sendFinalManually...');
              CTR.sendFinalManually();
            } else {
              console.error('CTR.sendFinalManually is not a function:', typeof CTR.sendFinalManually);
              CTR.toast('❌ Function not found');
            }
          } catch (error) {
            console.error('Error in send button click:', error);
            CTR.toast('❌ Error: ' + error.message);
          }
        });
      } else {
        console.error('Send button not found!');
      }

      document.getElementById('copy-btn').addEventListener('click', async () => {
        console.log('Copy button clicked');
        try {
          await navigator.clipboard.writeText(shareUrl.toString());
          CTR.toast('Link copied');
        } catch {
          CTR.toast('Copy failed');
        }
      });

      document.getElementById('restart-btn').addEventListener('click', () => {
        console.log('Restart button clicked');
        // Reset laps & cooldown; keep registration fields prefilled
        CTR.set('laps.count', '0');
        CTR.remove('laps.lastAt');
        CTR.remove('laps.lastTag');
        // Optional: require re-confirmation to start again
        CTR.set('runner.registered', '0');
        window.location.href = 'index.html';
      });

      window.addEventListener('online', CTR.trySync);
    });
  </script>
</body>
</html> 